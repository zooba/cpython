jobs:
- job: Detect_Docs
  displayName: Detect doc-only changes

  pool:
    vmImage: ubuntu-16.04

  steps:
  - script: |
     git fetch -q origin ${{ parameters.targetbranch }}
     if ! git diff --name-only HEAD $(git merge-base HEAD FETCH_HEAD) | grep -qvE '(\.rst$|^Doc|^Misc)'
     then
       echo "Only docs were updated, stopping build process."
       echo "##vso[task.setvariable variable=DocOnly,isOutput=true]true"
       exit
     fi
    displayName: Detect doc-only changes


- job: Docs_PR
  displayName: Docs PR

  pool:
    vmImage: ubuntu-16.04

  steps:
  - template: ./docs-steps.yml


- job: macOS_PR_Tests
  displayName: macOS PR Tests
  dependsOn: Detect_Docs

  variables:
    testRunTitle: '$(system.pullRequest.TargetBranch)-macos'
    testRunPlatform: macos

  pool:
    vmImage: xcode9-macos10.13

  steps:
  - template: ./macos-steps.yml
    parameters:
      targetBranch: $(System.PullRequest.TargetBranch)

  condition: and(succeeded(), ne(dependencies.Detect_Docs.outputs['DocOnly'], 'true'))


- job: Ubuntu_PR_Tests
  displayName: Ubuntu PR Tests
  dependsOn: Detect_Docs

  pool:
    vmImage: ubuntu-16.04

  variables:
    testRunTitle: '$(system.pullRequest.TargetBranch)-linux'
    testRunPlatform: linux
    openssl_version: 1.1.0g

  steps:
  - template: ./posix-steps.yml
    parameters:
      targetBranch: $(System.PullRequest.TargetBranch)

  condition: and(succeeded(), ne(dependencies.Detect_Docs.outputs['DocOnly'], 'true'))


- job: Windows_PR_Tests
  displayName: Windows PR Tests
  dependsOn: Detect_Docs

  pool:
    vmImage: vs2017-win2017

  strategy:
    matrix:
      win32:
        arch: win32
        buildOpt:
        testRunTitle: '$(System.PullRequest.TargetBranch)-win32'
        testRunPlatform: win32
      win64:
        arch: amd64
        buildOpt: '-p x64'
        testRunTitle: '$(System.PullRequest.TargetBranch)-win64'
        testRunPlatform: win64
    maxParallel: 2

  steps:
  - template: ./windows-steps.yml
    parameters:
      targetBranch: $(System.PullRequest.TargetBranch)

  condition: and(succeeded(), ne(dependencies.Detect_Docs.outputs['DocOnly'], 'true'))
