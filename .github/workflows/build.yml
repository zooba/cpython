name: build

on:
  push:
    branches:
    - master
    - 3.8
    - 3.7
  pull_request:
    branches:
    - master
    - 3.8
    - 3.7

jobs:
  build_win32:
    name: 'Windows (x86)'
    runs-on: windows-2019
    steps:
    - uses: actions/checkout@v1
    - name: Build CPython
      run: PCbuild\build.bat -e -p Win32
    - name: Display build info
      run: python.bat -m test.pythoninfo
    - name: Tests
      run: PCbuild\rt.bat -q -uall -u-cpu -rwW --slowest --timeout=1200 -j0

  build_win_amd64:
    name: 'Windows (x64)'
    runs-on: windows-2019
    steps:
    - uses: actions/checkout@v1
    - name: Build CPython
      run: PCbuild\build.bat -e -p x64
    - name: Display build info
      run: python.bat -m test.pythoninfo
    - name: Tests
      run: PCbuild\rt.bat -x64 -q -uall -u-cpu -rwW --slowest --timeout=1200 -j0

  build_ubuntu:
    name: 'Ubuntu 18.04'
    runs-on: ubuntu-18.04
    steps:
    - uses: actions/checkout@v1
    - name: Install Dependencies
      run: sudo ./.azure-pipelines/posix-deps-apt.sh 1.1.1c
    - name: Configure CPython
      run: ./configure --with-pydebug
    - name: Build CPython
      run: make -s -j4
    - name: Display build info
      run: make pythoninfo
    - name: Tests
      run: xvfb-run make buildbottest TESTOPTS="-j4 -uall,-cpu"

  build_macos:
    name: 'macOS 10.14'
    runs-on: macos-10.14
    steps:
    - uses: actions/checkout@v1
    - name: Configure CPython
      run: ./configure --with-pydebug --with-openssl=/usr/local/opt/openssl --prefix=/opt/python-dev
    - name: Build CPython
      run: make -s -j4
    - name: Display build info
      run: make pythoninfo
    - name: Tests
      run: make buildbottest TESTOPTS="-j4 -uall,-cpu"
